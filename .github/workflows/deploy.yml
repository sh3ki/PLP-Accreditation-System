name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - master  # Triggers on push to master branch
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "============================================="
            echo "ğŸš€ Starting Automated Deployment"
            echo "============================================="
            
            # Navigate to project directory
            cd /home/plpadmin/PLP-Accreditation-System/accreditation
            
            # Pull latest changes from GitHub
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            sudo -u plpadmin git pull origin master
            
            # Activate virtual environment
            echo "ğŸ”§ Activating virtual environment..."
            source /home/plpadmin/venv/bin/activate
            
            # Install/Update dependencies
            echo "ğŸ“¦ Installing dependencies..."
            pip install -r requirements.txt
            pip install python-docx reportlab  # For PDF conversion
            
            # Install LibreOffice for PDF conversion (if not already installed)
            if ! command -v libreoffice &> /dev/null; then
                echo "ğŸ“„ Installing LibreOffice for PDF conversion..."
                apt-get update -qq
                apt-get install -y -qq libreoffice
            fi
            
            # Collect static files
            echo "ğŸ“ Collecting static files..."
            python manage.py collectstatic --noinput
            
            # Run migrations (if any)
            echo "ğŸ—„ï¸ Running database migrations..."
            python manage.py migrate --noinput
            
            # Restart Gunicorn service
            echo "ğŸ”„ Restarting Gunicorn..."
            supervisorctl restart plp_accreditation
            
            # Restart Nginx
            echo "ğŸŒ Reloading Nginx..."
            systemctl reload nginx
            
            # Clear any cached data (optional)
            echo "ğŸ§¹ Clearing cache..."
            python manage.py shell -c "from django.core.cache import cache; cache.clear()" || true
            
            echo "============================================="
            echo "âœ… Deployment completed successfully!"
            echo "============================================="
            echo ""
            echo "ğŸ“Š Service Status:"
            supervisorctl status plp_accreditation
            systemctl status nginx --no-pager -l | head -5
            echo ""
            echo "ğŸŒ Your app is live at: http://72.60.41.211"
            echo "============================================="
