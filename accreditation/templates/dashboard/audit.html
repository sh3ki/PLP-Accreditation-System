{% extends 'dashboard_base.html' %}

{% block title %}Audit Trail{% endblock %}

{% block content %}
{% include 'components/toast_notifications.html' %}

<style>
    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .settings-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        flex-shrink: 0;
    }

    .stat-icon.green { background: linear-gradient(135deg, var(--plp-green), #66BB6A); }
    .stat-icon.blue { background: linear-gradient(135deg, #2196F3, #42A5F5); }
    .stat-icon.purple { background: linear-gradient(135deg, #9C27B0, #BA68C8); }

    .stat-info {
        flex: 1;
    }

    .stat-label {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #333;
        line-height: 1;
    }

    .stat-subtext {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }
    
    .search-and-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    
    .search-container {
        position: relative;
        flex: 1;
        min-width: 250px;
        max-width: 400px;
    }
    
    .search-input {
        padding: 8px 35px 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 100%;
        transition: all 0.3s;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--plp-green);
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
    }
    
    .filters-section {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-label {
        font-size: 12px;
        font-weight: 500;
        color: #666;
        white-space: nowrap;
    }
    
    .filter-select, .filter-date {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        min-width: 150px;
        background: white;
        cursor: pointer;
    }
    
    .filter-select:focus, .filter-date:focus {
        outline: none;
        border-color: var(--plp-green);
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .audit-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .audit-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .audit-table thead {
        background: var(--plp-green);
        color: white;
    }
    
    .audit-table thead th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .audit-table tbody tr {
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
    }
    
    .audit-table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .audit-table tbody tr:last-child {
        border-bottom: none;
    }
    
    .audit-table tbody td {
        padding: 15px;
        font-size: 14px;
        color: #333;
        vertical-align: middle;
    }

    .user-info {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .user-name {
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }

    .user-email {
        font-size: 12px;
        color: #666;
    }

    .action-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .action-badge.login {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .action-badge.login_history {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .action-badge.document_upload {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }

    .action-badge.report_generation {
        background-color: #e1f5fe;
        color: #0277bd;
    }

    .action-badge.record_modification {
        background-color: #fff3e0;
        color: #f57c00;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.success {
        background-color: #e8f5e9;
        color: #388e3c;
    }

    .status-badge.failed {
        background-color: #ffebee;
        color: #c62828;
    }

    .status-badge i {
        font-size: 14px;
    }

    .details-cell {
        max-width: 400px;
        font-size: 13px;
        color: #666;
    }

    .no-logs {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .no-logs i {
        font-size: 64px;
        color: #ddd;
        margin-bottom: 20px;
    }

    .no-logs h3 {
        font-size: 20px;
        color: #666;
        margin-bottom: 10px;
    }

    .no-logs p {
        font-size: 14px;
        color: #999;
    }

    @media (max-width: 768px) {
        .audit-table { font-size: 12px; }
        .audit-table th, .audit-table td { padding: 10px 8px; }
        .search-and-filters { flex-direction: column; align-items: stretch; }
        .search-container { max-width: 100%; }
    }
    
    /* Pagination Styles */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 30px 20px 20px;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .pagination-info {
        font-size: 14px;
        color: #666;
        margin-right: 10px;
    }
    
    .pagination {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .page-btn {
        min-width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        background: white;
        color: #333;
        cursor: pointer;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        padding: 0 12px;
    }
    
    .page-btn:hover:not(.active):not(.disabled) {
        background: var(--plp-green);
        color: white;
        border-color: var(--plp-green);
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }
    
    .page-btn.active {
        background: var(--plp-green);
        color: white;
        border-color: var(--plp-green);
        cursor: default;
        font-weight: 600;
    }
    
    .page-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f5f5f5;
    }
    
    .page-btn.ellipsis {
        cursor: default;
        border: none;
        background: transparent;
    }
    
    .page-btn.ellipsis:hover {
        transform: none;
        box-shadow: none;
    }
    
    .page-btn i {
        font-size: 12px;
    }
</style>

<div class="settings-header">
    <h1 class="settings-title">Audit Trail</h1>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon green"><i class="fas fa-clipboard-list"></i></div>
        <div class="stat-info">
            <div class="stat-label">Total Logs</div>
            <div class="stat-value" id="total-logs">{{ total_logs|default:0 }}</div>
            <div class="stat-subtext">All recorded actions</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon blue"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-info">
            <div class="stat-label">Today's Activity</div>
            <div class="stat-value" id="today-logs">{{ today_count|default:0 }}</div>
            <div class="stat-subtext">Actions today</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon purple"><i class="fas fa-file-upload"></i></div>
        <div class="stat-info">
            <div class="stat-label">Documents Uploaded</div>
            <div class="stat-value" id="document-uploads">{{ document_upload_count|default:0 }}</div>
            <div class="stat-subtext">Total uploads</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #FF9800, #FB8C00);"><i class="fas fa-edit"></i></div>
        <div class="stat-info">
            <div class="stat-label">Records Modified</div>
            <div class="stat-value" id="record-modifications">{{ record_modification_count|default:0 }}</div>
            <div class="stat-subtext">Total changes</div>
        </div>
    </div>
</div>

<div class="search-and-filters">
    <div class="search-container">
        <input type="text" id="filter-user" class="search-input" placeholder="Search by user email...">
        <i class="fas fa-search search-icon"></i>
    </div>
    <div class="filters-section">
        <div class="filter-group">
            <label class="filter-label">Action Type</label>
            <select id="filter-action" class="filter-select">
                <option value="">All Actions</option>
                <option value="login_history">Login History</option>
                <option value="document_upload">Document Upload</option>
                <option value="report_generation">Report Generation</option>
                <option value="record_modification">Record Modification</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Resource Type</label>
            <select id="filter-resource" class="filter-select">
                <option value="">All Resources</option>
                <option value="session">Session</option>
                <option value="user">User</option>
                <option value="department">Department</option>
                <option value="program">Program</option>
                <option value="accreditation_type">Accreditation Type</option>
                <option value="area">Area</option>
                <option value="checklist">Checklist</option>
                <option value="document">Document</option>
                <option value="report">Report</option>
                <option value="calendar_event">Calendar Event</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label">Date</label>
            <input type="date" id="filter-date" class="filter-date">
        </div>
    </div>
</div>

<div class="audit-container">
    {% if logs %}
    <table class="audit-table">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Action</th>
                <th>Status</th>
                <th>Details</th>
                <th>IP Address</th>
            </tr>
        </thead>
        <tbody id="audit-tbody">
            {% for log in logs %}
            <tr class="audit-row" 
                data-action="{{ log.action_category }}" 
                data-resource="{{ log.resource_type }}" 
                data-user="{{ log.user_email|default:'' }}" 
                data-date="{{ log.timestamp|slice:':10' }}">
                <td>{{ log.timestamp_display }}</td>
                <td>
                    <div class="user-info">
                        <span class="user-name">{{ log.user_name|default:'System' }}</span>
                        <span class="user-email">{{ log.user_email|default:'N/A' }}</span>
                    </div>
                </td>
                <td>
                    <span class="action-badge {{ log.action_category }}">{{ log.action_type_label }}</span>
                </td>
                <td>
                    {% if log.status_value == 'success' %}
                    <span class="status-badge success"><i class="fas fa-check-circle"></i> Success</span>
                    {% else %}
                    <span class="status-badge failed"><i class="fas fa-times-circle"></i> Failed</span>
                    {% endif %}
                </td>
                <td class="details-cell">{{ log.details }}</td>
                <td>{{ log.ip|default:'â€”' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-logs">
        <i class="fas fa-clipboard-list"></i>
        <h3>No Audit Logs Found</h3>
        <p>System activity will appear here once users start interacting with the application.</p>
    </div>
    {% endif %}
    
    <!-- Pagination -->
    {% if logs %}
    <div class="pagination-container">
        <div class="pagination-info">
            <i class="fas fa-info-circle"></i>
            Showing page {{ current_page }} of {{ total_pages }} ({{ total_logs }} total logs)
        </div>
        <div class="pagination">
            <!-- Previous Button -->
            <a href="?page={{ previous_page }}" class="page-btn {% if not has_previous %}disabled{% endif %}" {% if not has_previous %}onclick="return false;"{% endif %}>
                <i class="fas fa-chevron-left"></i>
            </a>
            
            <!-- Page Numbers -->
            {% for page_num in page_range %}
                {% if page_num == '...' %}
                    <span class="page-btn ellipsis">...</span>
                {% else %}
                    <a href="?page={{ page_num }}" class="page-btn {% if page_num == current_page %}active{% endif %}">
                        {{ page_num }}
                    </a>
                {% endif %}
            {% endfor %}
            
            <!-- Next Button -->
            <a href="?page={{ next_page }}" class="page-btn {% if not has_next %}disabled{% endif %}" {% if not has_next %}onclick="return false;"{% endif %}>
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
// Audit Trail JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const filterAction = document.getElementById('filter-action');
    const filterResource = document.getElementById('filter-resource');
    const filterUser = document.getElementById('filter-user');
    const filterDate = document.getElementById('filter-date');
    const auditRows = document.querySelectorAll('.audit-row');

    // Store the original total count from server
    const originalTotalCount = parseInt('{{ logs|length|default:0 }}') || 0;

    function applyFilters() {
        const actionValue = filterAction.value.toLowerCase();
        const resourceValue = filterResource.value.toLowerCase();
        const userValue = filterUser.value.toLowerCase();
        const dateValue = filterDate.value;
        
        let visibleCount = 0;
        
        auditRows.forEach(row => {
            const action = row.dataset.action ? row.dataset.action.toLowerCase() : '';
            const resource = row.dataset.resource ? row.dataset.resource.toLowerCase() : '';
            const user = row.dataset.user ? row.dataset.user.toLowerCase() : '';
            const date = row.dataset.date || '';
            
            const matchAction = !actionValue || action === actionValue;
            const matchResource = !resourceValue || resource === resourceValue;
            const matchUser = !userValue || user.includes(userValue);
            const matchDate = !dateValue || date === dateValue;
            
            if (matchAction && matchResource && matchUser && matchDate) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update Total Logs to show filtered count (or original if no filters)
        const isFiltering = actionValue || resourceValue || userValue || dateValue;
        const totalLogsElement = document.getElementById('total-logs');
        if (totalLogsElement) {
            totalLogsElement.textContent = isFiltering ? visibleCount : originalTotalCount;
        }
    }

    if (filterAction) filterAction.addEventListener('change', applyFilters);
    if (filterResource) filterResource.addEventListener('change', applyFilters);
    if (filterUser) filterUser.addEventListener('input', applyFilters);
    if (filterDate) filterDate.addEventListener('change', applyFilters);
});
{% endblock %}